<div class="deal-form-container">
  <app-navigation></app-navigation>
  <div class="content">
    <mat-card>
    <mat-card-header>
      <mat-card-title>{{ isEditMode ? 'Edit Deal' : 'Create New Deal' }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="dealForm" (ngSubmit)="onSubmit()">
        <!-- Edit mode: Only summary, sector, dealType -->
        <ng-container *ngIf="isEditMode">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Summary</mat-label>
              <textarea matInput formControlName="summary" rows="4" required></textarea>
              <mat-error *ngIf="dealForm.get('summary')?.hasError('required')">
                Summary is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Sector</mat-label>
              <input matInput formControlName="sector" required>
              <mat-error *ngIf="dealForm.get('sector')?.hasError('required')">
                Sector is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Deal Type</mat-label>
              <input matInput formControlName="dealType" required>
              <mat-error *ngIf="dealForm.get('dealType')?.hasError('required')">
                Deal Type is required
              </mat-error>
            </mat-form-field>
          </div>
        </ng-container>

        <!-- Create mode: Backend expects dealName (REQUIRED), clientName, dealType, sector, summary, currentStage -->
        <ng-container *ngIf="!isEditMode">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Deal Name</mat-label>
              <input matInput formControlName="dealName" required>
              <mat-error *ngIf="dealForm.get('dealName')?.hasError('required')">
                Deal name is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Client Name</mat-label>
              <input matInput formControlName="clientName" required>
              <mat-error *ngIf="dealForm.get('clientName')?.hasError('required')">
                Client name is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Deal Type</mat-label>
              <input matInput formControlName="dealType" required>
              <mat-error *ngIf="dealForm.get('dealType')?.hasError('required')">
                Deal type is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Sector</mat-label>
              <input matInput formControlName="sector" required>
              <mat-error *ngIf="dealForm.get('sector')?.hasError('required')">
                Sector is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Summary</mat-label>
              <textarea matInput formControlName="summary" rows="4" required></textarea>
              <mat-error *ngIf="dealForm.get('summary')?.hasError('required')">
                Summary is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Current Stage</mat-label>
              <mat-select formControlName="currentStage" required>
                <mat-option *ngFor="let stage of dealStages" [value]="stage.value">
                  {{ stage.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="dealForm.get('currentStage')?.hasError('required')">
                Stage is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Notes (Optional)</mat-label>
              <textarea matInput formControlName="notes" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-row" *ngIf="isAdmin">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Deal Value</mat-label>
              <input matInput type="number" formControlName="dealValue" [min]="0">
              <mat-error *ngIf="dealForm.get('dealValue')?.hasError('min')">
                Deal value must be a positive number
              </mat-error>
            </mat-form-field>
          </div>
        </ng-container>

        <div class="form-actions">
          <button mat-button type="button" (click)="cancel()" [disabled]="loading">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || dealForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20" class="inline-spinner"></mat-spinner>
            <span *ngIf="!loading">{{ isEditMode ? 'Update' : 'Create' }}</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
  </div>
</div>
